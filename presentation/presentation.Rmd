---
title: "Factors affecting frequency of Volcanic eruptions"
subtitle: "Presentation subtitle (if any)"
author: "x404-pagenotfound <br> Emma, Bridget, Sachin"
institute: "University of Edinburgh"
date: "4 December 2020"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(tidyverse)
library(broom)
library(janitor)
library(glue)
library(choroplethr)
library(choroplethrMaps)
library(leaflet)

```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
# Load your data here
setwd("/cloud/project/proposal")
volcano <- read_csv("../data/volcano.csv")
eruptions <- read_csv("../data/eruptions.csv")
events <- read_csv("../data/events.csv")
```

```{r data-for-map, include=FALSE}
#Join eruptions and volcano to match each eruption to its corresponding volcano
volcanic_eruption <- left_join(volcano, eruptions, by="volcano_number")
#load df with list of countries
data("country.regions")
#create CountVolc which stores number of eruptions for each country
CountVolc = group_by(volcanic_eruption, country) %>% summarise(value = n())
CountVolc = as.data.frame(CountVolc)
CountVolc[,1] = tolower(CountVolc[,1])
rownames(CountVolc) = CountVolc$country

#some eruptions are on the border between two countries, so we split that count between each country
CountVolc["chile","value"] = CountVolc["chile","value"] + CountVolc["chile-argentina","value"]/2
CountVolc["argentina","value"] = CountVolc["argentina","value"] + CountVolc["chile-argentina","value"]/2

#some country names must be changed to get the count
CountVolc$country=gsub("united states", "united states of america", CountVolc$country)

#Aggregating the counts into unique country names
CountVolcUni <- group_by(CountVolc, country) %>%
  summarise(value = sum(value))
CountVolcUni = as.data.frame(CountVolcUni)
rownames(CountVolcUni) = CountVolcUni$country

```

class: center, middle

## A statement of the overall goal / research question

---

class: inverse, center, middle

# Volcano Dataset

---


background-image: url(https://camo.githubusercontent.com/4295e3eef5545f83277639df7e7b73fa7de3bc5722c0da60d5ff44b6e1f3df8d/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f636f6d6d6f6e732f7468756d622f332f33342f4572757063692543332542336e5f656e5f656c5f766f6c632543332541316e5f536162616e636179612532435f5065722543332542412e6a70672f3132383070782d4572757063692543332542336e5f656e5f656c5f766f6c632543332541316e5f536162616e636179612532435f5065722543332542412e6a7067)

---
# World Map showing Number of Volcanic Eruptions

```{r World-Map, echo=FALSE}
#create tibble with rownames as countries
CountVolcFake = country.regions
CountVolcFake$value = 0
rownames(CountVolcFake) = CountVolcFake$region
#choose the countries in both tibbles
ii=intersect(CountVolcUni$country,country.regions$region)
CountVolcFake[ii, "value"] = (CountVolcUni[ii, "value"])
#create choropleth map with palette
country_choropleth(CountVolcFake, num_colors = 9) +
scale_fill_brewer(palette="YlOrRd") +
labs(title = "Number of Volcanic Eruptions by Country")




#find countries that arent included
MissingCountries = CountVolcUni$country[!CountVolcUni$country %in% country.regions$region]
```


---

```{r, echo=FALSE}
set.seed(1)
ran_rows <- sample(nrow(volcanic_eruption), 1000)
leaflet(data = volcanic_eruption) %>% 
  addTiles() %>%
  addMarkers(~longitude.x, ~latitude.x, popup = ~as.character(volcano_name.x), label = ~as.character(volcano_name.x), clusterOptions = markerClusterOptions())
```

---

```{r, echo=FALSE}
leaflet(volcanic_eruption) %>% 
  addTiles() %>%
  addCircleMarkers(
    ~longitude.x, ~latitude.x,
    radius = 3,
    color = "red",
    stroke = FALSE, fillOpacity = 0.4
  )
```


--- 

# Map eruptions as data points compared with tectonic plates

---

class: inverse, center, middle

#Tectonics Explanation (brief geography lesson)

---

#Earth's Structure

Earths Structure:
The earth is formed of 4 layers, 
the crust, 
the mantle, 
the inner and outer core. 

In terms of volcano formation we are only really concerned with the crust and mantle.

The crust is the top layer (the one we live on) which is a relatively thin layer of solid rock. This is split into sections known as tectonic plates which lie on top of the mantle- the second outermost layer formed of partially molten rock (magma) which moves very slowly. This causes the plates to move (only about a couple of cm per year) which, depending on the direction of movement can cause earthquakes and volcano formation. 

---

#Plates and Crust type
The crust variable refers to the crust type and thickness of the plate the volcano is on,
In our data there are four categories:

-Continental (>25 km)- land plates 

-Oceanic (< 15 km)- sea plates

-Intermediate (15-25 km)

-Unknown 

Continental crust is much thicker than oceanic crust however oceanic crust is made of much denser rock than continental plates making them heavier despite their thin composition.

After research it is still unclear what intermediate crust is however by observing the data they appear to categorize the crust type by thickness so it is potentially a collection of volcanos  thicker than average oceanic crust and thinner than average continental crust.

---

#Tectonic Settings

The tectonic setting of a volcano is the movements of the plates that has caused the formation of the given volcano. There are three different tectonic settings in the dataset:

*Subduction zone:* 
This when a continental and oceanic plate move towards each other, the heavier oceanic plate moves beneath the lighter continental plate, down into the mantle. This creates more magma and pressure near the surface which works its way through the continental plate to form a volcano.

*Rift zone:* 
This is when two plates are moving away from each other forming a gap in the crust which magma moves up through to form a volcano.

*Intraplate:* 
These form when there is a much hotter area of the mantle, causing the magma to rise to the surface where it is then pushed through the crust to form a volcano on the surface.

---

# Map eruptions by tectonic plate type

```{r seperate-techtonics, echo=FALSE}
volcano_tecs <- volcano%>%
  #filter out Vitim Volcanic Field volcano as tec settings are unknown
  filter(tectonic_settings != "Unknown")%>%
  #seperate the tec setting from the crust 
  separate(tectonic_settings, c("techtonic_setting", "crust"),
                    sep = "([/])")
  
```

```{r eruption-frequency, echo=FALSE}
eruption_tecs<- left_join(volcano_tecs, eruptions,
                          by=c("volcano_number", "volcano_name",
                               "latitude", "longitude"))
  
eruption_tecs_fqncy <- eruption_tecs%>%
  count(volcano_number, volcano_name, techtonic_setting, crust) %>% 
  mutate(frequency = as.factor(n))%>%
  #str_trim("crust", side = "left")%>%
  #ideally remove whitespace for easier use but leave for later
  filter(crust != " Crustal thickness unknown")
  

  
```

```{r tec-map, echo = FALSE}
tec_pal<- colorFactor(
  palette = c("#a50026", "#313695", "#4d9221"),
  domain = eruption_tecs$techtonic_setting
)
#red=intraplate
#blue=riftzone
#green=subductionzone


leaflet(eruption_tecs) %>% 
  addTiles() %>%
  addCircleMarkers(
    ~longitude, ~latitude,
    radius = 3,
    color = ~tec_pal(techtonic_setting),
    stroke = FALSE, 
    fillOpacity = 0.4
  )
```
---

# Map of Crust type

```{r crust-map, echo=FALSE}
crust_pal<- colorFactor(
  palette = c("#d73027", "#762a83", "#fee090", "#4575b4"),
  domain = eruption_tecs$crust
)
#red=continental
#yellow=intermediate
#blue=oceanic
#purple=unknown


leaflet(eruption_tecs) %>% 
  addTiles() %>%
  addCircleMarkers(
    ~longitude, ~latitude,
    radius = 3,
    color = ~crust_pal(crust),
    stroke = FALSE, 
    fillOpacity = 0.4
  )
```
---

# Model frequency by crust type

A linear model was initially fit to the data to try to predict how many times the volcano would erupt depending on the crust type.

Coefficients:
                        (Intercept)  
                             10.103  
crust Intermediate crust (15-25 km)  
                             -3.345  
      crust Oceanic crust (< 15 km)  
                              2.766  

The output shows that for all else held constant, we would expect:

-A volcano on continental crust to erupt an average of 10.103 times

-A volcano on intermediate crust to erupt an average of 3.345 less times than that of a continental crust

-A volcano on oceanic crust to erupt an average of 2.766 more times than that of a continental crust.

---

#However...
The residuals plot shows three distinct clusters of data for each different crust type:
```{r crust-model, echo= FALSE}
crust_fit <- 
linear_reg()%>%
  set_engine("lm")%>%
  fit(n ~ crust, data= eruption_tecs_fqncy)

```
```{r crust-fit-residuals, echo= FALSE}
crust_fit_aug <- augment(crust_fit$fit)

ggplot(crust_fit_aug, mapping=aes( x=.fitted, y =.resid, colour = crust)) +
	geom_jitter(alpha=0.8) +
	geom_hline(yintercept=0, color="gray", lty="dashed" )+ 
	labs(x="Predicted Frequency of Volcanic Eruptions", y="Residuals", colour = "Crust type (thickness)")+
  scale_colour_manual(values = c(
    " Continental crust (>25 km)" = "#d73027",
    " Oceanic crust (< 15 km)" = "#4575b4",
    " Intermediate crust (15-25 km)" = "#fee090"))
```

---
#Adjusted R Squared

In addition, the adjusted R squared value for this model was 0.002351574, meaning the model is only accurate for a very small proportion of the data.


The two separate evaluations allowed us to conclude that the linear model was unsuitable for the data in hand.

---
# Model frequency by tectonic setting

When modeling frequency by tectonic setting we encountered a very similar occurence.

Whilst the output of the model provided us with plausible values;

The adjusted R squared value was 0.01215089, again only accounting for a very small portion of the data.

---

The residuals plot was again split into 3 clusters, one for each tectonic setting.

```{r tec_setting-model, echo=FALSE}
tec_fit <- linear_reg()%>%
  set_engine("lm")%>%
  fit(n ~ techtonic_setting, data= eruption_tecs_fqncy)
```

```{r tec_setting-residuals, echo=FALSE}
tec_fit_aug <- augment(tec_fit$fit)

ggplot(tec_fit_aug, mapping=aes( x=.fitted, y =.resid, 
                                 colour = techtonic_setting)) +
	geom_jitter(alpha=0.8) +
	geom_hline(yintercept=0, color="gray", lty="dashed" )+
	labs(x="Predicted Frequency of Volcanic Eruptions", y="Residuals",
	     colour = "Tectonic Setting")+
    scale_colour_manual(values = c(
    "Intraplate " = "#a50026",
    "Rift zone " = "#313695",
    "Subduction zone " = "#4d9221"))
```

---
# What we decided

We decided that linear models weren't effective and could provide an adequate explanation of the frequency of eruptions through bar charts showing the count on each plate

---

# Count on each crust

```{r viz, echo=FALSE}
eruption_tecs_fqncy%>%
  group_by(crust)%>%
  ggplot(aes(y = fct_rev(fct_infreq(crust)), fill = crust))+
  geom_bar()+
  labs(y = "Crust Type (thickness)",
       x = "Eruptions", 
       title = "Frequency of eruptions on different crusts")+
  scale_fill_manual(values = c(
    " Continental crust (>25 km)" = "#d73027",
    " Oceanic crust (< 15 km)" = "#4575b4",
    " Intermediate crust (15-25 km)" = "#fee090"))+
  guides(fill = FALSE)
```  


---

## Eruptions by year by crust
```{r eruptions-by-year-crust}
#eruption_tecs%>%
 # group_by(start_year)%>%
 # count(start_year)


eruption_tecs%>%
  group_by(crust)%>%
  filter(crust != " Crustal thickness unknown")%>%
  ggplot(aes(x= start_year,
             fill = crust))+
           geom_histogram(binwidth = 2000)+
    scale_fill_manual(values = c(
    " Continental crust (>25 km)" = "#d73027",
    " Oceanic crust (< 15 km)" = "#4575b4",
    " Intermediate crust (15-25 km)" = "#fee090"))
  
  

```

---

# Count for each tectonic setting

```{r viz2, echo = FALSE}
eruption_tecs_fqncy%>%
  group_by(techtonic_setting)%>%
  ggplot(aes(y = techtonic_setting, fill = techtonic_setting))+
  geom_bar()+
    labs(y = "Tectonic Setting",
       x = "Eruptions", 
       title = "Frequency of eruptions for different tectonic settings")+
  scale_fill_manual(values = c(
    "Intraplate " = "#a50026",
    "Rift zone " = "#313695",
    "Subduction zone " = "#4d9221"))+
  guides(fill = FALSE)
  

```

---

# Bar chart frequency by country by volcano type

```{r eruptions-by-country-and-volcano-type, echo=FALSE}

volcanic_eruption %>%
  group_by(country, primary_volcano_type) %>%
   mutate( freq_eruptions=n(),
          primary_volcano_type=if_else(primary_volcano_type=="Stratovolcano(es)", "Stratovolcano", primary_volcano_type) ) %>%
  arrange(desc(freq_eruptions)) %>%
  distinct(country, primary_volcano_type, freq_eruptions) %>%
  head(25)%>%
  ggplot(aes(x=country,y=freq_eruptions)) +
  geom_col(aes(fill=primary_volcano_type)) +
  coord_flip() +
  labs(x="Country",y="Number of Eruptions", title="Frequency of Eruptions by Country", subtitle="and Vocano Type", fill="Primary Volcano Type") +
  scale_fill_brewer(palette="YlOrRd")


```
---
# Bar chart frequency by volcano type

```{r eruptions-by-volcano-type, echo=FALSE}

volcanic_eruption %>%
  group_by(primary_volcano_type) %>%
  mutate( freq_eruptions=n(),
          primary_volcano_type=if_else(primary_volcano_type=="Stratovolcano(es)", "Stratovolcano", primary_volcano_type) ) %>%
  arrange(desc(freq_eruptions)) %>%
  distinct(primary_volcano_type, freq_eruptions) %>%
  head(10)%>%
  ggplot(aes(x=fct_rev(as.factor(primary_volcano_type)),y=freq_eruptions,fill=primary_volcano_type)) +
  geom_col() +
  coord_flip() +
  labs(x="Primary Volcano Type",y="Number of Eruptions", title="Frequency of Eruptions by Vocano Type") +
  scale_fill_brewer(palette="YlOrRd")

```
---
```{r count-volcanoes-by-volcano-type, echo=FALSE}

volcano %>%
  group_by(primary_volcano_type) %>%
  mutate( primary_volcano_type=case_when(
    primary_volcano_type=="Stratovolcano(es)"~"Stratovolcano",
    primary_volcano_type=="Shield(s)"~"Shield",
    primary_volcano_type=="Pyroclastic cone(s)"~"Pyroclastic cone",
    TRUE ~ primary_volcano_type
    )) %>%
  ggplot(aes(x=fct_rev(as.factor(primary_volcano_type)),fill=primary_volcano_type)) +
  geom_bar() +
  coord_flip() +
  labs(x="Primary Volcano Type",y="Count", title="Number of Volcanoes by Vocano Type")

```

---
# Short Comings
-A lot of NAs in the event table around dates, due to some ancient volcanic eruptions being recorded
-Also several eruptions are ongoing in the world, therefore finish date not recorded
- Therefore we could not investigate what factors affect the length of eruptions like we had initially proposed, which lead us to writing a re-proposal. 
---
# Conclusion
We believe the factors which affect volcanic eruptions according to our investigation are : 
-Location of volcano (position on tectonic plate)
-Tectonic Plate Setting
-Tectonic Plate Type
-Crust Type
-Primary Volcano Type

We also hypothesize that there may be a relationship between these factors, based on our findings.
---
#Future research/Investigation
- Investigate the relationship between the factors which affect the volcanic eruptions - cause them to arise, how frequently they arise etc